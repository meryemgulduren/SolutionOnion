@using SO.Application.DTOs.ProposalModule.Proposal
@model SO.Application.Features.Queries.ProposalModule.Proposal.GetByIdProposal.GetByIdProposalQueryResponse

@{
    var proposal = Model.Result as SingleProposal;
}

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Identify Customers and Final Deliverables</h5>
    </div>
    <div class="card-body">
        <form asp-action="UpdateCustomersAndDeliverables" asp-route-id="@proposal.Id" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Id" value="@proposal.Id" />
            @* --- Customers/Beneficiary Tablosu --- *@
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="card-subtitle text-muted">Customers</h6>
                <button type="button" id="addBeneficiaryBtn" class="btn btn-sm btn-success">Yeni Faydalanıcı Ekle</button>
            </div>
            <table class="table table-bordered mb-4">
                <thead class="table-light">
                    <tr>
                        <th style="width: 45%;">Customers/Beneficiary</th>
                        <th style="width: 45%;">Needs and Concern</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody id="beneficiariesContainer">
                    @if (proposal.CustomerBeneficiaries != null && proposal.CustomerBeneficiaries.Any())
                    {
                        for (int i = 0; i < proposal.CustomerBeneficiaries.Count; i++)
                        {
                            <tr class="beneficiary-row">
                                <td><input name="CustomerBeneficiaries[@i].Beneficiary" class="form-control" value="@proposal.CustomerBeneficiaries[i].Beneficiary" /></td>
                                <td><input name="CustomerBeneficiaries[@i].NeedsAndConcern" class="form-control" value="@proposal.CustomerBeneficiaries[i].NeedsAndConcern" /></td>
                                <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">Sil</button></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            @* --- Final Deliverables Tablosu (Milestone'ları kullanıyoruz) --- *@
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="card-subtitle text-muted">Final Deliverables</h6>
                <button type="button" id="addDeliverableBtn" class="btn btn-sm btn-success">Yeni Teslimat Ekle</button>
            </div>
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th style="width: 45%;">Deliverable</th>
                        <th style="width: 45%;">Description</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody id="deliverablesContainer">
                    @if (proposal.Milestones != null && proposal.Milestones.Any())
                    {
                        for (int i = 0; i < proposal.Milestones.Count; i++)
                        {
                            <tr class="deliverable-row">
                                <td><input name="Milestones[@i].Name" class="form-control" value="@proposal.Milestones[i].Name" /></td>
                                <td><textarea name="Milestones[@i].Description" class="form-control" rows="2">@proposal.Milestones[i].Description</textarea></td>
                                <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">Sil</button></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-primary">Kaydet ve Devam Et</button>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Beneficiary tablosu için dinamik satır ekleme/silme
        setupDynamicRows('#addBeneficiaryBtn', '#beneficiariesContainer', 'beneficiary-row', 'CustomerBeneficiaries',
            `<td><input name="CustomerBeneficiaries[{index}].Beneficiary" class="form-control" /></td>
             <td><input name="CustomerBeneficiaries[{index}].NeedsAndConcern" class="form-control" /></td>`);

        // Deliverables tablosu için dinamik satır ekleme/silme
        setupDynamicRows('#addDeliverableBtn', '#deliverablesContainer', 'deliverable-row', 'Milestones',
            `<td><input name="Milestones[{index}].Name" class="form-control" /></td>
             <td><textarea name="Milestones[{index}].Description" class="form-control" rows="2"></textarea></td>`);

        // Genel satır ekleme/silme fonksiyonu
        function setupDynamicRows(addButtonId, containerId, rowClass, namePrefix, cellsHtml) {
            let index = $(`${containerId} .${rowClass}`).length;

            $(addButtonId).click(function () {
                var newRow = `<tr class="${rowClass}">${cellsHtml.replace(/{index}/g, index)}<td><button type="button" class="btn btn-danger btn-sm remove-row-btn">Sil</button></td></tr>`;
                $(containerId).append(newRow);
                index++;
            });

            $(document).on('click', `${containerId} .remove-row-btn`, function () {
                $(this).closest('tr').remove();
                $(`${containerId} .${rowClass}`).each(function(i, tr) {
                    $(tr).find('input, textarea').each(function() {
                        var oldName = $(this).attr('name');
                        var newName = oldName.replace(/\[\d+\]/, '[' + i + ']');
                        $(this).attr('name', newName);
                    });
                });
                index = $(`${containerId} .${rowClass}`).length;
            });
        }
    });
</script>