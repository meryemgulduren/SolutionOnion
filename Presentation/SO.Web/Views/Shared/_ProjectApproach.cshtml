@using SO.Application.DTOs.ProposalModule.Proposal
@model SO.Application.Features.Queries.ProposalModule.Proposal.GetByIdProposal.GetByIdProposalQueryResponse

@{
    var proposal = Model.Result as SingleProposal;
}

<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Define Project Approach</h5>
    </div>
    <div class="card-body">
        <form asp-action="UpdateProjectApproach" asp-route-id="@proposal.Id" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Id" value="@proposal.Id" />
            <h6 class="card-subtitle mb-2 text-muted">Project Approach</h6>
            <div class="form-group mb-3">
                <label class="form-label fw-bold">Phasing</label>
                <textarea name="Phasing" class="form-control" rows="4">@proposal.Phasing</textarea>
            </div>
            <div class="form-group mb-3">
                <label class="form-label fw-bold">Outsourcing Plans</label>
                <textarea name="OutsourcingPlans" class="form-control" rows="2">@proposal.OutsourcingPlans</textarea>
            </div>
            <div class="form-group mb-3">
                <label class="form-label fw-bold">Interoperability</label>
                <textarea name="Interoperability" class="form-control" rows="2">@proposal.Interoperability</textarea>
            </div>

            <hr class="my-4" />

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="card-subtitle text-muted">Project Timeframe</h6>
                <button type="button" id="addTimeframeBtn" class="btn btn-sm btn-success">Yeni Aktivite Ekle</button>
            </div>
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%;">Activity</th>
                        <th style="width: 20%;">Date</th>
                        <th style="width: 30%;">Rationale</th>
                        <th style="width: 10%;"></th>
                    </tr>
                </thead>
                <tbody id="timeframeContainer">
                    @if (proposal.Milestones != null && proposal.Milestones.Any())
                    {
                        for (int i = 0; i < proposal.Milestones.Count; i++)
                        {
                            <tr class="timeframe-row">
                                <td><input name="Milestones[@i].Name" class="form-control" value="@proposal.Milestones[i].Name" /></td>
                                <td><input name="Milestones[@i].PlannedCompletionDate" class="form-control" type="date" value="@proposal.Milestones[i].PlannedCompletionDate.ToString("yyyy-MM-dd")" /></td>
                                <td><input name="Milestones[@i].Description" class="form-control" value="@proposal.Milestones[i].Description" /></td>
                                <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">Sil</button></td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-primary">Kaydet ve Devam Et</button>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function () {
        setupDynamicRows('#addTimeframeBtn', '#timeframeContainer', 'timeframe-row',
            `<td><input name="Milestones[{index}].Name" class="form-control" /></td>
             <td><input name="Milestones[{index}].PlannedCompletionDate" class="form-control" type="date" /></td>
             <td><input name="Milestones[{index}].Description" class="form-control" /></td>`);

        function setupDynamicRows(addButtonId, containerId, rowClass, cellsHtml) {
            let index = $(`${containerId} .${rowClass}`).length;

            $(addButtonId).click(function () {
                var newRow = `<tr class="${rowClass}">${cellsHtml.replace(/{index}/g, index)}<td><button type="button" class="btn btn-danger btn-sm remove-row-btn">Sil</button></td></tr>`;
                $(containerId).append(newRow);
                index++;
            });

            $(document).on('click', `${containerId} .remove-row-btn`, function () {
                $(this).closest('tr').remove();
                $(`${containerId} .${rowClass}`).each(function(i, tr) {
                    $(tr).find('input, textarea').each(function() {
                        var oldName = $(this).attr('name');
                        if (oldName) {
                            var newName = oldName.replace(/\[\d+\]/, '[' + i + ']');
                            $(this).attr('name', newName);
                        }
                    });
                });
                index = $(`${containerId} .${rowClass}`).length;
            });
        }
    });
</script>